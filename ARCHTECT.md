# electron化に伴うアプリケーション設計のメモ

## 1. electronによって実現する機能
electron化することで、以下の点を実現する。  

1. node.jsやdev-server等のローカル環境を整備する必要なく、winのネイティブアプリケーションとして容易に実行できるようにする
2. ローカルファイルの読み書きを可能とする

特に2は重要である。


## 2. 必要機能の検討

### (1) winネイティブアプリケーションとして動作すること
mac対応も容易に可能だが、今回は動作要件がwin PC上なので、とりあえずwindows向けに作ることにする。  
デフォルトの設定で基本的に問題ない。  
別途、ファイル読み書きプログラムの当たりはディレクトリ構造を考える必要があるくらいだと思う


### (2) ローカルファイルの読み書き機能の実装
今回、必要な読み書き機能は以下の通り。

1. 生徒情報データベースとなるxlsxファイル
2. その日1日分の自習室利用データを保存するファイル(json形式、以下、today.jsonと呼ぶ)
3. (アプリケーション終了時に自動的に、当日分のデータを1ヶ月分にまとめてある保存データファイルに上書き (xlsx形式、以下、month.jsonと呼ぶ))

3は必要だったら付け加える機能とするので、一旦保留。  
これらを実現するため、アプリケーションのライフサイクル上でのプログラム実行を考える。  

### ライフサイクルと実行タイミング
1. アプリケーション起動時
アプリケーションを起動したタイミングで、today.jsonファイルが存在するかチェックし、
存在した場合は該当データを読み込んでアプリケーション内部の変数に反映

2. ユーザーによる操作が行われた時
入退室時、ユーザーによる捜査が行われた直後、today.jsonファイルを上書きする。  
トラブルによるアプリケーション落ちの状況を想定し、何らかの方法でファイルのコピーを取っておく

3. アプリケーション終了時
アプリケーション終了時、特定の時間帯(=自習室利用終了時間を過ぎていたら)だったら、
自動でmonth.jsonファイルの上書きを行う。  
month.jsonファイルは粉川がVBAでjson読み込みプログラムを書いているので、本ライフサイクル機能を実装する場合は  
REST API的な仕組みを考える必要がある。


### electron化後のディレクトリ構成

public/
  electron.js
  index.html

src/
  app.config.js
  App.js

  others/
    (NOT NEED FILES)

  components/
    (VIEW COMPONENT PROGRAMS FOR REACT)

  electron/
    <!-- !NEW! ファイル書き出しを担当 -->
    write.js
    <!-- !NEW! ファイル読み込みを担当 -->
    read.js


### write.js, read.js
Node.jsの機能を利用してローカルファイル読み書き機能を行うプログラムを作成する。  
作成にあたって、electronのIPCシステムを利用する。  
すなわち、レンダラプロセス上でReactが動作し、Reactコンポーネント内からipcRenderer.sendSync()  を用いてイベントを発火、  
electron.jsで該当イベントが実行され、実行結果として該当ローカルファイルの読み込み結果、また書き出し結果をreturnする。  
なお、ファイル読み込み操作なのでasync(nodeの○○Sync系関数)を利用し、~~ローディング画面をUIに追加する。~~  
  ->思ったより待機時間が短い(ほぼゼロ)ので、ローディング画面はいらないものとする

#### FLOW CHART
main-proc -> (IPC) -> render-proc::async:<USER::ACTIVATE_ELECTRON_EVENT> -> (IPC) -> main-proc::<ACTIVATED_ELECTRON_EVENT>.execute() -> (IPC) -> render-proc::getReturnValue



### "元に戻す"の実装
誤って他人を登録・退席させてしまった場合、それを取り消す操作ができると良い。  
ただし、以下を満たすとする。  

#### "元に戻す"の必要条件
+ 直前の操作のみ取り消す。一度行った取り消し操作を取り消すことはできない。
+ 連続して複数回分の操作を取り消すことは不可能とする(いたずら対策)
+ 取り消し操作のログは別途残す。もしかしたら後で役に立つかも

#### "元に戻す"機能関連の問題点
+ 他人が誤って操作を行った後、気づかずに放置された、あるいは悪意を持って操作を行った場合はどうするか？：整合性をどうやってとるか、どの程度のケースまで想定するべきか
+ 実装形式が未定(仕様が決まらないと設計不可)：単なるログ方式(実装面でバグが出やすいが計算量は少ない)、合成関数方式(バグは出にくいが計算量は増える)が候補